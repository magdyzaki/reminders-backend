# خطوات ضبط MongoDB Atlas حتى يعمل السيرفر (Koyeb)

عند ظهور خطأ **SSL / tlsv1 alert internal error** غالباً السبب واحد من اثنين:  
إما أن Atlas يرفض الاتصال من عنوان IP السيرفر، أو أن كلمة المرور في الرابط فيها رموز تحتاج ترميز.

---

## 1) Network Access — السماح لأي IP بالاتصال

السيرفر على Koyeb ما له عنوان IP ثابت. لو في Atlas سمحت فقط لـ IP معين، الاتصال يفشل.  
الحل: نسمح **لأي عنوان IP** (0.0.0.0/0).

### الخطوات بالترتيب

1. ادخل على موقع **MongoDB Atlas**:  
   https://cloud.mongodb.com  
   وسجّل الدخول.

2. من الصفحة الرئيسية اختر **المشروع (Project)** اللي فيه الـ Cluster تاعك.

3. من القائمة الجانبية اضغط **Network Access** (تحت قسم "Security").

   *(إذا ظهرت رسالة "Current IP Address not added" — هذا طبيعي، معناها أنك تحتاج تضيف عنواناً. أكمل الخطوة التالية.)*

   **مهم:** إذا أضفت فقط عنوان جهازك (مثل 154.183.233.11)، السيرفر على **Koyeb** له عنوان مختلف ولن يقدر يتصل. لذلك نحتاج نضيف **أيضاً** 0.0.0.0/0 (السماح من أي مكان) حتى يعمل الباكند على Koyeb.

4. اضغط الزر الأخضر **Add IP Address**.

5. في النافذة الصغيرة:
   - اختر **Allow Access from Anywhere**  
     (أو اكتب يدوياً: **0.0.0.0/0** في خانة IP).
   - في "Comment" يمكن تكتب مثلاً: Koyeb.
   - اضغط **Confirm**.

6. بعد دقائق قليلة يظهر السطر الجديد بحالة **Active**.  
   من هنا Atlas يقبل اتصال من أي مكان (ومنها سيرفر Koyeb).

---

## 2) كلمة المرور في الـ URI

الرابط (Connection string) ي looks كده تقريباً:

```text
mongodb+srv://اسم_المستخدم:كلمة_المرور@cluster0.xxxxx.mongodb.net/...
```

لو **كلمة_المرور** فيها أحد هذه الرموز، لازم نرمّزها في الرابط وإلا الاتصال قد يفشل (وأحياناً يظهر خطأ SSL):

| الرمز | نستبدله بـ |
|--------|------------|
| `@`    | `%40`      |
| `#`    | `%23`      |
| `:`    | `%3A`      |
| `/`    | `%2F`      |
| `?`    | `%3F`      |
| `%`    | `%25`      |
| `&`    | `%26`      |
| `=`    | `%3D`      |
| `+`    | `%2B`      |
| مسافة  | `%20`      |

### مثال

- كلمة المرور الأصلية: `Pass#123`
- في الرابط نكتب: `Pass%23123`

يعني كل `#` تصير `%23` داخل الجزء الخاص بكلمة المرور فقط.

### أين نضع الرابط بعد التعديل؟

في **Koyeb** → مشروعك → **Settings** → **Environment variables** → المتغير **MONGODB_URI**.  
الصق الرابط الكامل بعد ما تكون عدّلت كلمة المرور بالترميز أعلاه، ثم احفظ واعمل **Redeploy**.

---

## ملخص سريع

1. **Network Access:**  
   Atlas → Network Access → Add IP Address → **Allow Access from Anywhere** (0.0.0.0/0) → Confirm.

2. **كلمة المرور:**  
   لو فيها رموز مثل `#` أو `@` أو `:`، استبدلها في الرابط حسب الجدول (مثلاً `#` → `%23`)، وضع الرابط المعدّل في **MONGODB_URI** في Koyeb ثم Redeploy.

بعد تنفيذ الاثنين جرّب السيرفر مرة ثانية؛ لو ظهر أي رسالة خطأ جديدة انسخها وسنكمل عليها.
